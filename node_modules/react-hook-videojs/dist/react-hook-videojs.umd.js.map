{"version":3,"file":"react-hook-videojs.umd.js","sources":["../src/index.tsx"],"sourcesContent":["import React, {\n  useRef,\n  useState,\n  useLayoutEffect,\n  useCallback,\n  forwardRef,\n  HTMLProps,\n  MutableRefObject,\n} from \"react\";\nimport videojs, { VideoJsPlayer, VideoJsPlayerOptions } from \"video.js\";\nimport cloneDeep from \"lodash.clonedeep\";\nimport { dequal } from \"dequal\";\n\n// Function copied from\n// https://github.com/kentcdodds/use-deep-compare-effect/blob/main/src/index.ts\nfunction useDeepCompareMemoize<T>(value: T): T {\n  const ref = React.useRef<T>(value);\n  const signalRef = React.useRef<number>(0);\n\n  if (!dequal(value, ref.current)) {\n    ref.current = value;\n    signalRef.current += 1;\n  }\n\n  return React.useMemo(() => ref.current, [signalRef.current]);\n}\n\n// Integrating React and video.js is a bit tricky, especially when supporting\n// React 18 strict mode. We'll do our best to explain what happens in inline comments.\n\nconst VideoJsWrapper = forwardRef<\n  VideoJsPlayer,\n  {\n    children: React.ReactNode;\n    videoJsOptions: VideoJsPlayerOptions;\n    onReady: () => void;\n    onDispose: () => void;\n    classNames: string;\n  }\n>(\n  (\n    { children, videoJsOptions, onReady, onDispose, classNames, ...props },\n    playerRef\n  ) => {\n    const player = playerRef as MutableRefObject<VideoJsPlayer | null>;\n    // video.js sometimes mutates the provided options object.\n    // We clone it to avoid mutation issues.\n    const videoJsOptionsCloned = cloneDeep(videoJsOptions);\n    const videoNode = useRef<HTMLVideoElement | null>(null);\n    const containerRef = useRef<HTMLDivElement | null>(null);\n\n    useLayoutEffect(() => {\n      if (!videoNode.current?.parentNode) return;\n\n      // Once we initialize the player, videojs will start mutating the DOM.\n      // We need a snapshot of the state just before, so we know what state\n      // to reset the DOM to.\n      const originalVideoNodeParent =\n        videoNode.current.parentNode.cloneNode(true);\n\n      if (!player.current) {\n        player.current = videojs(videoNode.current, videoJsOptionsCloned);\n        player.current.ready(() => {\n          onReady();\n        });\n      }\n\n      return (): void => {\n        // Whenever something changes in the options object, we\n        // want to reinitialize video.js, and destroy the old player by calling `player.current.dispose()`\n\n        if (player.current) {\n          player.current.dispose();\n\n          // Unfortunately, video.js heavily mutates the DOM in a way that React doesn't\n          // like, so we need to readd the removed DOM elements directly after dispose.\n          // More concretely, the node marked with `data-vjs-player` will be removed from the\n          // DOM. We are readding the cloned original video node parent as it was when React first rendered it,\n          // so it is once again synchronized with React.\n          if (\n            containerRef.current &&\n            videoNode.current?.parentNode &&\n            !containerRef.current.contains(videoNode.current.parentNode)\n          ) {\n            containerRef.current.appendChild(originalVideoNodeParent);\n            videoNode.current =\n              originalVideoNodeParent.firstChild as HTMLVideoElement;\n          }\n\n          player.current = null;\n          onDispose();\n        }\n      };\n\n      // We'll use the serialized videoJsOptions object as a dependency object\n    }, [useDeepCompareMemoize(videoJsOptions)]);\n\n    return (\n      // TODO: can we get by withour introducing an extra div?\n      <div ref={containerRef}>\n        <div data-vjs-player>\n          <video\n            ref={videoNode}\n            className={`video-js ${classNames}`}\n            {...props}\n          >\n            {children}\n          </video>\n        </div>\n      </div>\n    );\n  }\n);\n\nVideoJsWrapper.displayName = \"VideoJsWrapper\";\n\ntype VideoProps = {\n  children?: React.ReactNode;\n} & Partial<HTMLProps<HTMLVideoElement>>;\n\ntype VideoType = (props: VideoProps) => JSX.Element;\n\nexport const useVideoJS = (\n  videoJsOptions: VideoJsPlayerOptions,\n  classNames = \"\"\n): {\n  Video: VideoType;\n  ready: boolean;\n  player: VideoJsPlayer | null;\n} => {\n  const [ready, setReady] = useState(false);\n\n  // player will contain the video.js player object, once it is ready.\n  const player = useRef<VideoJsPlayer>(null);\n  const Video = useCallback(\n    ({ children, ...props }: VideoProps) => (\n      <VideoJsWrapper\n        videoJsOptions={videoJsOptions}\n        classNames={classNames}\n        onReady={(): void => setReady(true)}\n        onDispose={(): void => setReady(false)}\n        {...props}\n        ref={player}\n      >\n        {children}\n      </VideoJsWrapper>\n    ),\n    [useDeepCompareMemoize(videoJsOptions), classNames]\n  );\n\n  return { Video, ready, player: player.current };\n};\n"],"names":["React","dequal","forwardRef","cloneDeep","useRef","useLayoutEffect","videojs","useState","useCallback"],"mappings":";;;;;;;;AAeA,iCAAkC,OAAa;AACvC,UAAA,MAAMA,eAAAA,QAAM,OAAU,KAAK;AAC3B,UAAA,YAAYA,eAAAA,QAAM,OAAe,CAAC;AAExC,QAAI,CAACC,OAAAA,OAAO,OAAO,IAAI,OAAO,GAAG;AAC/B,UAAI,UAAU;AACd,gBAAU,WAAW;AAAA,IACvB;AAEO,WAAAD,eAAA,QAAM,QAAQ,MAAM,IAAI,SAAS,CAAC,UAAU,OAAO,CAAC;AAAA,EAC7D;AAKA,QAAM,iBAAiBE,MAUrB,WAAA,CACE,EAAE,UAAU,gBAAgB,SAAS,WAAW,eAAe,SAC/D,cACG;AACH,UAAM,SAAS;AAGT,UAAA,uBAAuBC,2BAAU,cAAc;AAC/C,UAAA,YAAYC,aAAgC,IAAI;AAChD,UAAA,eAAeA,aAA8B,IAAI;AAEvDC,UAAAA,gBAAgB,MAAM;;AAChB,UAAA,CAAC,iBAAU,YAAV,mBAAmB;AAAY;AAKpC,YAAM,0BACJ,UAAU,QAAQ,WAAW,UAAU,IAAI;AAEzC,UAAA,CAAC,OAAO,SAAS;AACnB,eAAO,UAAUC,iBAAA,QAAQ,UAAU,SAAS,oBAAoB;AACzD,eAAA,QAAQ,MAAM,MAAM;AACjB;QAAA,CACT;AAAA,MACH;AAEA,aAAO,MAAY;;AAIjB,YAAI,OAAO,SAAS;AAClB,iBAAO,QAAQ;AAOf,cACE,aAAa,WACb,kBAAU,YAAV,oBAAmB,eACnB,CAAC,aAAa,QAAQ,SAAS,UAAU,QAAQ,UAAU,GAC3D;AACa,yBAAA,QAAQ,YAAY,uBAAuB;AACxD,sBAAU,UACR,wBAAwB;AAAA,UAC5B;AAEA,iBAAO,UAAU;AACP;QACZ;AAAA,MAAA;AAAA,IAID,GAAA,CAAC,sBAAsB,cAAc,CAAC,CAAC;AAE1C,WAEGN,+BAAA,QAAA,cAAA,OAAA;AAAA,MAAI,KAAK;AAAA,IAAA,GACPA,+BAAA,QAAA,cAAA,OAAA;AAAA,MAAI,mBAAe;AAAA,IAAA,GACjBA,+BAAA,QAAA,cAAA,SAAA;AAAA,MACC,KAAK;AAAA,MACL,WAAW,YAAY;AAAA,MACtB,GAAG;AAAA,IAAA,GAEH,QACH,CACF,CACF;AAAA,EAEJ,CACF;AAEA,iBAAe,cAAc;AAQhB,QAAA,aAAa,CACxB,gBACA,aAAa,OAKV;AACH,UAAM,CAAC,OAAO,YAAYO,MAAA,SAAS,KAAK;AAGlC,UAAA,SAASH,aAAsB,IAAI;AACzC,UAAM,QAAQI,kBACZ,CAAC,EAAE,aAAa,YACbR,+BAAAA,QAAA,cAAA,gBAAA;AAAA,MACC;AAAA,MACA;AAAA,MACA,SAAS,MAAY,SAAS,IAAI;AAAA,MAClC,WAAW,MAAY,SAAS,KAAK;AAAA,MACpC,GAAG;AAAA,MACJ,KAAK;AAAA,IAAA,GAEJ,QACH,GAEF,CAAC,sBAAsB,cAAc,GAAG,UAAU,CACpD;AAEA,WAAO,EAAE,OAAO,OAAO,QAAQ,OAAO,QAAQ;AAAA,EAChD;;;;"}